<!DOCTYPE html>
<html>

<head>
    <title>Pr√°ctica 1</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="css/nuevoAviso.css">
    <%- include("links") %>
    <link rel="stylesheet" href="css/avisos.css">
</head>

<body>

    <nav class="navbar navbar-expand-sm bg-dark">
        <div class="container-fluid">
            <div class="nav-brand">
                <img src="img/LogoUCM.png" alt="">
            </div>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item mt-auto mb-auto ms-2">
                        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalPerfil">
                            <%=nombre%>
                        </button> 
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <img class="rounded-circle me-4 ms-4 " src="imagen/<%=email%>" alt="">
                    </li>
                    <li class="nav-item mt-auto mb-auto">
                        <button type="button" class="btn btn-danger" onclick="window.location.href='/cerrarSesion'">Desconectar</button>
                    </li> 
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">

        <div class="row mt-5">
            <div class="col">
                <div class="btn-group">
                    <% if(tecnico){ %> 
                        <a href="/avisosEntrantes" class="btn btn-outline-primary">Avisos Entrantes</a>
                    <% } %> 
                    <a href="/avisos" class="btn btn-outline-primary">Mis Avisos</a>
                    <a href="/historicoAvisos" class="btn btn-outline-primary">Historico de avisos</a>
                    <% if(tecnico){ %>
                        <a href="/avisos" class="btn btn-outline-primary">Gestion de usuarios</a>
                    <% } %> 
                </div>
            </div>
            <div class="col">
                <div class="d-flex">
                    <input class="form-control me-1" id="buscar" type="search" placeholder="Buscar" aria-label="Search">
                    <button class="btn btn-primary" type="submit">Buscar</button>
                </div>
            </div>
        </div>
        
    
            <table class="table table-striped table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Texto</th>
                        <th>Tipo</th>
                        <% if(!tecnico) {%> 
                            <th>Tecnico</th>
                        <% }else{ %> 
                            <th>Acciones</th>
                        <% } %> 

                    </tr>
                </thead>
                <tbody>
                    <% avisos.forEach(function(aviso, i){%>
                        <tr data-id="<%=i%>" data-toggle="modal"data-bs-toggle="modal" data-bs-target="#verAviso">
                            <td> <%= aviso.fecha.toLocaleDateString("en-US") %> </td>
                            <td class="texto"> <%= aviso.texto.substr(0,200) %> </td>
                            <td> <img class="tipoLogo" src="/img/<%= aviso.tipo %>.png" alt=""></td>                            
                            <% if(!tecnico) {%> 
                                <td> <%= aviso.idTecnico %> </td>
                            <% }else{ %> 
                                <td class="acciones">
                                    <img class="tipoLogo asignarTecnico" data-id="<%=i%>" data-toggle="modal"data-bs-toggle="modal" data-bs-target="#asignarTecnico" src="/img/<%= url %>.png" alt="">
                                    <% if(!entrantes){ %> 
                                    <form action="/completarAviso/<%= aviso.idAviso %> ", method="POST" class="">
                                        <input type="image" src="/img/basura.png" class="tipoLogo" alt="Submit">
                                    </form>       
                                    <% }else{ %>
                                        <img class="tipoLogo" src="/img/basura.png" alt="">
                                    <% } %> 
                                </td>
                            <% } %> 
                        </tr>

                    <% }) %> 
                </tbody>
            </table>

            <%- include("verAviso") %>
            <%- include("asignarTecnico") %>
            
            <% if(!tecnico){%> 
                <div class="d-flex justify-content-end">
                    <button class="btn btn-success" data-toggle="modal"data-bs-toggle="modal" data-bs-target="#exampleModal">Nuevo
                        aviso</button>
                    <%- include("nuevoAviso")%>             
                </div>
            <%  } %> 
    </div>

    <%- include("perfil") %>
    <%- include("scripts") %>
</body>


</html>


<% if(entrantes){ %> 

<script>

  $(".asignarTecnico").on("click", function(event){
        let id = $(this).data("id")
        let avisos =  `<%-JSON.stringify(avisos)%>`
        avisos = JSON.parse(avisos)

        console.log(avisos[id])
        let t = `Aviso ${avisos[id].idAviso}`
        $("#modalAsig_idAviso").text(t)
        $("#modalAsig_idAvisoEnviar").text(t)

        let date = new Date(avisos[id].fecha)
        $("#modalAsig_fecha").prop("value", date.toLocaleDateString("en-US"))
        $("#modalAsig_area").prop("value", avisos[id].area)
        $("#modalAsig_obs").text(avisos[id].texto)

        let comentarios = (avisos[id].respuesta) ? avisos[id].respuesta : ""
        $("#modalAsig_res").text(comentarios)
    })

</script>

<% } %> 

<script>
    $("tr").on("click", function(event){
       let id = $(this).data("id")
       let avisos =  `<%-JSON.stringify(avisos)%>`
       avisos = JSON.parse(avisos)

       console.log(avisos[id])
       let t = `Aviso ${avisos[id].idAviso}`
       $("#modal_idAviso").text(t)
       $("#modal_idAvisoEnviar").text(t)

       let date = new Date(avisos[id].fecha)
       $("#modal_fecha").prop("value", date.toLocaleDateString("en-US"))
       $("#modal_area").prop("value", avisos[id].area)
       $("#modal_obs").text(avisos[id].texto)

       let comentarios = (avisos[id].respuesta) ? avisos[id].respuesta : ""
       $("#modal_res").text(comentarios)
   })
</script> 


<script>

    $("#buscar").on("keyup", function(event){

        let texto = $("#buscar").prop("value").toUpperCase()
        let cols = $(".texto") //busca por campo nombre

        for (let i = 0; i < cols.length; i++){
            let t = cols.eq(i).text().toUpperCase() //Valor del campo texto
            if (t.indexOf(texto) < 0)
                cols.eq(i).parent().hide() //El padre de la columna es la fila entera. Se oculta
            else
                cols.eq(i).parent().show() //El padre de la columna es la fila entera. Se muestra
           
        }
        
    })

</script>
